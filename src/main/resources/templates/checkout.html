<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thông tin giao hàng</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .checkout-container {
      max-width: 720px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div class="checkout-container">
  <h4 class="mb-4"><i class="bi bi-truck"></i> Thông tin giao hàng</h4>
  <!-- Thông báo lỗi -->
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- Thông báo thành công -->
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

  <form th:action="@{/payment/vnpay}" method="post">

    <!-- Hidden username -->
    <input type="hidden" name="username" th:value="${user.username}" />
    <!-- Hidden final address -->
    <input type="hidden" name="address" id="address" />

    <!-- Họ tên -->
    <div class="mb-3">
      <label class="form-label">Họ tên người nhận</label>
      <input type="text" name="fullName" class="form-control" th:value="${user.fullName}" required />
    </div>

    <!-- Số điện thoại -->
    <div class="mb-3">
      <label class="form-label">Số điện thoại</label>
      <input type="text" name="phone" class="form-control" th:value="${user.phone}" required />
    </div>

    <!-- Tỉnh / TP -->
    <div class="mb-3">
      <label class="form-label">Tỉnh / Thành phố</label>
      <select id="province" name="province" class="form-select" required>
        <option value="">-- Chọn tỉnh --</option>
      </select>
    </div>

    <!-- Quận / Huyện -->
    <div class="mb-3">
      <label class="form-label">Quận / Huyện</label>
      <select id="district" name="district" class="form-select" required disabled>
        <option value="">-- Chọn quận/huyện --</option>
      </select>
    </div>

    <!-- Phường / Xã -->
    <div class="mb-3">
      <label class="form-label">Phường / Xã</label>
      <select id="ward" name="ward" class="form-select" required disabled>
        <option value="">-- Chọn phường/xã --</option>
      </select>
    </div>

    <!-- Số nhà -->
    <div class="mb-3">
      <label class="form-label">Số nhà / Tên đường</label>
      <input type="text" name="street" class="form-control" placeholder="VD: 123 Nguyễn Trãi" required />
    </div>

    <!-- Ghi chú -->
    <div class="mb-3">
      <label class="form-label">Ghi chú (tuỳ chọn)</label>
      <textarea name="note" class="form-control" rows="2"></textarea>
    </div>

    <!-- Tổng tiền -->
    <div class="mb-3 text-end fw-bold">
      Tổng tiền:
      <span th:text="${#numbers.formatDecimal(cart.getTotalPrice(), 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
    </div>

    <!-- Nút xác nhận -->
    <div class="d-grid">
      <button type="submit" class="btn btn-success">
        <i class="bi bi-credit-card"></i> Xác nhận đặt hàng
      </button>
    </div>
    <div class="d-grid">
      <button type="submit" class="btn btn-danger">
        <i class="bi bi-credit-card-2-front-fill"></i> Thanh toán qua VNPAY
      </button>
    </div>
  </form>
</div>

<!-- Load địa chỉ tỉnh/huyện/xã -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const provinceSelect = document.getElementById("province");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");

    // Load tỉnh
    fetch("https://provinces.open-api.vn/api/p/")
            .then(res => res.json())
            .then(data => {
              data.forEach(p => {
                provinceSelect.innerHTML += `<option value="${p.code}" data-name="${p.name}">${p.name}</option>`;
              });
            });

    // Khi chọn tỉnh, load quận/huyện
    provinceSelect.addEventListener("change", () => {
      const code = provinceSelect.value;
      districtSelect.innerHTML = '<option value="">-- Chọn quận/huyện --</option>';
      wardSelect.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
      wardSelect.disabled = true;

      if (code !== "") {
        fetch(`https://provinces.open-api.vn/api/p/${code}?depth=2`)
                .then(res => res.json())
                .then(data => {
                  data.districts.forEach(d => {
                    districtSelect.innerHTML += `<option value="${d.code}" data-name="${d.name}">${d.name}</option>`;
                  });
                  districtSelect.disabled = false;
                });
      }
    });

    // Khi chọn huyện, load phường/xã
    districtSelect.addEventListener("change", () => {
      const districtCode = districtSelect.value;
      fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
              .then(res => res.json())
              .then(detail => {
                wardSelect.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
                detail.wards.forEach(w => {
                  wardSelect.innerHTML += `<option value="${w.name}">${w.name}</option>`;
                });
                wardSelect.disabled = false;
              });
    });

    // Trước khi submit, gộp địa chỉ vào input hidden
    document.querySelector("form").addEventListener("submit", function () {
      const street = document.querySelector("input[name='street']").value;
      const province = provinceSelect.options[provinceSelect.selectedIndex].text;
      const district = districtSelect.options[districtSelect.selectedIndex].text;
      const ward = wardSelect.options[wardSelect.selectedIndex].text;

      const fullAddress = `${street}, ${ward}, ${district}, ${province}`;
      document.getElementById("address").value = fullAddress;
    });
  });
</script>

</body>
</html>
